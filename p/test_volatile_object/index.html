<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="# æœ¬æ–‡è¦çœ‹å•¥ å…ˆä¸ç»†è°ˆvolatileçš„åŸºæœ¬åŸç†,åœ¨è¯»(å†™)è¿™ç¯‡æ–‡ç« æ—¶,éƒ½æ˜¯å‡è®¾æˆ‘ä»¬å·²ç»ç²—ç•¥äº†è§£äº†ä¸€ç‚¹volatileçš„åŸç†å’Œä½œç”¨çš„,ä¸»è¦å°±æ˜¯"><title>test_volatile_object</title>
<link rel=canonical href=https://heeexy.com/p/test_volatile_object/><link rel=stylesheet href=/scss/style.min.8e60baf4cd3fc55968717a6e39762f4d28ed7ef6007566b6c7970ad0fe907198.css><meta property='og:title' content="test_volatile_object"><meta property='og:description' content="# æœ¬æ–‡è¦çœ‹å•¥ å…ˆä¸ç»†è°ˆvolatileçš„åŸºæœ¬åŸç†,åœ¨è¯»(å†™)è¿™ç¯‡æ–‡ç« æ—¶,éƒ½æ˜¯å‡è®¾æˆ‘ä»¬å·²ç»ç²—ç•¥äº†è§£äº†ä¸€ç‚¹volatileçš„åŸç†å’Œä½œç”¨çš„,ä¸»è¦å°±æ˜¯"><meta property='og:url' content='https://heeexy.com/p/test_volatile_object/'><meta property='og:site_name' content='è¡—ä¸Šçš„åŠ¨ç‰©å›­'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='java'><meta property='article:tag' content='ç¬”è®°'><meta property='article:published_time' content='2017-09-18T22:28:29+00:00'><meta property='article:modified_time' content='2017-09-18T22:28:29+00:00'><meta name=twitter:title content="test_volatile_object"><meta name=twitter:description content="# æœ¬æ–‡è¦çœ‹å•¥ å…ˆä¸ç»†è°ˆvolatileçš„åŸºæœ¬åŸç†,åœ¨è¯»(å†™)è¿™ç¯‡æ–‡ç« æ—¶,éƒ½æ˜¯å‡è®¾æˆ‘ä»¬å·²ç»ç²—ç•¥äº†è§£äº†ä¸€ç‚¹volatileçš„åŸç†å’Œä½œç”¨çš„,ä¸»è¦å°±æ˜¯"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=https://img.heeexy.com/avatar.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><div class=site-meta><h1 class=site-name><a href=/>è¡—ä¸Šçš„åŠ¨ç‰©å›­</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/tags><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg>
<span>Tags</span></a></li><li><a href=/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
<span>Categories</span></a></li><li><a href=/archives><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li class=menu-bottom-section><ol class=menu></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">ç›®å½•</h2><div class=widget--toc><nav id=TableOfContents><ol><li><ol><li><a href=#æœ¬æ–‡è¦çœ‹å•¥>æœ¬æ–‡è¦çœ‹å•¥</a></li><li><a href=#å¼€å§‹ä»£ç å§>å¼€å§‹ä»£ç å§</a><ol><li><a href=#çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„boolean>çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„boolean</a></li><li><a href=#çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„å¯¹è±¡>çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„å¯¹è±¡</a></li><li><a href=#åŸåšè¯„è®ºåŒºçš„è§£ç–‘>åŸåšè¯„è®ºåŒºçš„è§£ç–‘</a></li><li><a href=#ç•™ä¸‹æ›´å¤šçš„ç–‘æƒ‘>ç•™ä¸‹æ›´å¤šçš„ç–‘æƒ‘</a></li></ol></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E5%B9%B6%E5%8F%91/>å¹¶å‘</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/test_volatile_object/>test_volatile_object</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 10, 2017</time></div></footer></div></header><section class=article-content><h3 id=æœ¬æ–‡è¦çœ‹å•¥><a href=#%e6%9c%ac%e6%96%87%e8%a6%81%e7%9c%8b%e5%95%a5>#</a>
æœ¬æ–‡è¦çœ‹å•¥</h3><hr><p>å…ˆä¸ç»†è°ˆvolatileçš„åŸºæœ¬åŸç†,åœ¨è¯»(å†™)è¿™ç¯‡æ–‡ç« æ—¶,éƒ½æ˜¯å‡è®¾æˆ‘ä»¬å·²ç»ç²—ç•¥äº†è§£äº†ä¸€ç‚¹volatileçš„åŸç†å’Œä½œç”¨çš„,ä¸»è¦å°±æ˜¯ &ldquo;<u>è¯»å†™éƒ½èµ°ä¸»å†…å­˜,ä¿è¯ä»»æ„çº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡çš„å¯è§æ€§</u>&rdquo;</p><p>åœ¨æŸ¥çœ‹springæºç çš„æ—¶å€™,æ³¨æ„åˆ°springåœ¨å¤„ç†å¹¶å‘çš„æ“ä½œList<string>æ—¶, è™½ç„¶å¯¹listä½¿ç”¨äº†volatile, ç„¶è€Œå‘listé‡Œé¢æ·»åŠ å…ƒç´ æ—¶,ç”¨çš„è¿˜æ˜¯æ–°å»ºä¸€ä¸ªlist,å¤åˆ¶å…¨éƒ¨æ—§å€¼,å¢åŠ æ–°å…ƒç´ ,ç„¶åå°†æ—§çš„liståœ°å€æŒ‡å‘æ–°çš„list.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> 	</span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>updatedDefinitions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>beanDefinitionNames</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>updatedDefinitions</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>beanDefinitionNames</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>updatedDefinitions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>beanName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>beanDefinitionNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>updatedDefinitions</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ä¹ˆéº»çƒ¦çš„æ“ä½œ,ç¬¬ä¸€ååº”å°±æ˜¯,volatileä¿®é¥°çš„list, ç›´æ¥æ·»åŠ å…ƒç´ <strong>ä¾ç„¶ä¸å®‰å…¨</strong>ä¹ˆ?</p><p>å»ç½‘ä¸Šæœäº†ä¸€ä¸‹ç›¸å…³é—®é¢˜, <a class=link href=http://blog.csdn.net/u014108122/article/details/38173201 target=_blank rel=noopener>å‚è€ƒåšæ–‡åœ°å€</a> ,å‘ç°ä¸æ­¢list, å¯¹è±¡ä¹Ÿæ˜¯ä¸€æ ·çš„.</p><p>æœ¬æ–‡å°±æ˜¯è¦æ¥ç”¨ä»£ç ç›´è§‚åœ°çœ‹çœ‹volatile åˆ°åº•æœ‰ä»€ä¹ˆæ•ˆæœ,æ€ä¹ˆç”¨æ‰æœ‰æ•ˆæœ.</p><h3 id=å¼€å§‹ä»£ç å§><a href=#%e5%bc%80%e5%a7%8b%e4%bb%a3%e7%a0%81%e5%90%a7>#</a>
å¼€å§‹ä»£ç å§</h3><hr><h4 id=çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„boolean><a href=#%e7%ba%bf%e7%a8%8b%e5%85%b1%e4%ba%ab%e5%af%b9%e8%b1%a1%e9%87%8c%e7%9a%84boolean>#</a>
çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„boolean</h4><p>æ³¨æ„ä»£ç è¦ä»¥**-serveræ¨¡å¼**è¿è¡Œï¼Œå¼ºåˆ¶è™šæ‹Ÿæœºå¼€å¯ä¼˜åŒ–</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>VolatileObjectTest</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åŠ ä¸Švolatile å°±å¯ä»¥æ­£å¸¸ç»“æŸWhileå¾ªç¯äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ObjectA</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>VolatileObjectTest</span><span class=p>(</span><span class=n>ObjectA</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>a</span><span class=p>.</span><span class=na>setFlag</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>isFlag</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>         	 æ³¨æ„è¿™é‡Œçš„sysout,å¦‚æœæœ‰è°ƒç”¨çš„è¯,å³ä½¿æ²¡æœ‰volatile,å­çº¿ç¨‹ä¹Ÿç»å¸¸èƒ½æ‹¿åˆ°a.flag,
</span></span></span><span class=line><span class=cl><span class=cm>         	 ç»“åˆåé¢çš„æµ‹è¯•,å‘ç°sysout æˆ–è€… sysout(a.isFlag())ä¹‹å‰æœ‰&#34;---&#34;ä¹‹ç±»å­—ç¬¦ä¸²
</span></span></span><span class=line><span class=cl><span class=cm>         	 éƒ½å¯èƒ½è®©aå»ä»ä¸»å†…å­˜å»è·å–å€¼,å½±å“æˆ‘ä»¬æµ‹è¯•çš„ç»“æœ
</span></span></span><span class=line><span class=cl><span class=cm>         	 æ‰€ä»¥æµ‹è¯•çš„æ—¶å€™ä¸è¦ä¹±æ‰“sysoutäº†,æ„Ÿå…´è¶£çš„è¯å¯ä»¥è‡ªå·±å»å„ç§æµ‹è¯•ä¸€é
</span></span></span><span class=line><span class=cl><span class=cm>          */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// System.out.println();  </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å­çº¿ç¨‹æ­£å¸¸ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// æ³¨æ„ä»£ç è¦ä»¥-serveræ¨¡å¼è¿è¡Œï¼Œå¼ºåˆ¶è™šæ‹Ÿæœºå¼€å¯ä¼˜åŒ–</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå¯åŠ¨çš„æ—¶å€™åŠ ä¸Š-server å‚æ•°åˆ™ä¼š è¾“å‡º Java HotSpot(TM) Server VM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;java.vm.name&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>VolatileObjectTest2</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>VolatileObjectTest2</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ObjectA</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>test</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>200</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>test</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>200</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ä¸»çº¿ç¨‹ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>ObjectA</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isFlag</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setFlag</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸ªä»£ç è¿˜æ˜¯å¾ˆç®€å•,</p><p>ä¸»çº¿ç¨‹å°†açš„flagæ”¹ä¸ºfalse,</p><p>å­çº¿ç¨‹èƒ½æ­£å¸¸ç»“æŸçš„è¯, è¯´æ˜å­çº¿ç¨‹é‡Œ a çš„ flagå€¼è·å–åˆ°äº†false,</p><p>ä¸èƒ½æ­£å¸¸ç»“æŸçš„è¯, è¯´æ˜å­çº¿ç¨‹aä¸€ç›´éƒ½æ˜¯ç”¨å…¶æœ¬åœ°å†…å­˜é‡Œçš„flagå€¼,ä¸€ç›´éƒ½æ˜¯true.</p><p>æµ‹è¯•ç»“æœå°±æ˜¯</p><ol><li>æœ‰volatile ä¿®é¥°çš„æƒ…å†µä¸‹, å­çº¿ç¨‹èƒ½æ‹¿åˆ°falseå€¼</li><li>æ²¡æœ‰volatile ,å­çº¿ç¨‹æ— æ³•æ­£å¸¸ç»“æŸ</li></ol><p>åœ¨åˆæ­¥äº†è§£volatile çš„å¯è§æ€§çš„æƒ…å†µä¸‹, æˆ‘ä¼šè§‰å¾—è¿™ä¸ªç»“æœå¾ˆæ­£å¸¸, è§‰å¾—è‡ªå·±æŒæ¡äº†volatile , ä½†æ˜¯æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹&mldr;</p><h4 id=çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„å¯¹è±¡><a href=#%e7%ba%bf%e7%a8%8b%e5%85%b1%e4%ba%ab%e5%af%b9%e8%b1%a1%e9%87%8c%e7%9a%84%e5%af%b9%e8%b1%a1>#</a>
çº¿ç¨‹å…±äº«å¯¹è±¡é‡Œçš„å¯¹è±¡</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>VolatileObjectTest</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// åŠ ä¸Švolatile å°±å¯ä»¥æ­£å¸¸ç»“æŸWhileå¾ªç¯äº†</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>ObjectA</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>VolatileObjectTest</span><span class=p>(</span><span class=n>ObjectA</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>a</span><span class=p>.</span><span class=na>getObjectB</span><span class=p>().</span><span class=na>setFlag</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ObjectB</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getObjectB</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=na>isFlag</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=na>isFlag</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>a</span><span class=p>.</span><span class=na>getObjectB</span><span class=p>().</span><span class=na>isFlag</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;å­çº¿ç¨‹æ­£å¸¸ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// å¦‚æœå¯åŠ¨çš„æ—¶å€™åŠ ä¸Š-server å‚æ•°åˆ™ä¼š è¾“å‡º Java HotSpot(TM) Server VM</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>getProperty</span><span class=p>(</span><span class=s>&#34;java.vm.name&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>VolatileObjectTest</span><span class=w> </span><span class=n>test</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>VolatileObjectTest</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ObjectA</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=n>test</span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>200</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>test</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>200</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;ä¸»çº¿ç¨‹ç»“æŸ&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>ObjectA</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>ObjectB</span><span class=w> </span><span class=n>objectB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ObjectB</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isFlag</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setFlag</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>ObjectB</span><span class=w> </span><span class=nf>getObjectB</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>objectB</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>ObjectB</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isFlag</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setFlag</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>flag</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>this</span><span class=p>.</span><span class=na>flag</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><p>è¿™æ¬¡åœ¨ObjectAå†…æ·»åŠ äº†ä¸€ä¸ªæˆå‘˜å˜é‡ObjectB,æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­è·³å‡ºå¾ªç¯éœ€è¦ObjectBä¸­çš„flagå˜ä¸ºfalse;</p><p>å®é™…æµ‹è¯•æ—¶å‘ç°:</p><ol><li>æ— è®ºObjectAå‰æœ‰æ²¡æœ‰ volatile, è°ƒç”¨stop()æ–¹æ³•éƒ½å¹¶ä¸èƒ½æ­£ç¡®ç»ˆæ­¢å­çº¿ç¨‹</li><li>æˆå‘˜å˜é‡ObjectBå‰æ·»åŠ volatile,åŒæ ·ä¸èƒ½æ­£ç¡®ç»ˆæ­¢å­çº¿ç¨‹</li><li>ObjectBçš„flagå‰åŠ volatile,å¯ä»¥ç»ˆæ­¢å­çº¿ç¨‹ (è¿™æ˜¯å½“ç„¶çš„å•¦&mldr;)</li><li>å¦‚æœå¾ªç¯é‡Œç”¨çš„æ˜¯ <code>while (a.getObjectB().isFlag())</code> , ObjectAå‰åˆæœ‰volatileçš„è¯, è¿™æ ·è¿˜æ˜¯å¯ä»¥ç»ˆæ­¢å­çº¿ç¨‹.</li></ol><p>æµ‹åˆ°è¿™é‡Œ,æ„Ÿè§‰è¿™ä¸ªåšä¸»ç»™çš„ä¾‹å­æ˜¯ä¸æ˜¯æœ‰é—®é¢˜å•Š,</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=n>ObjectB</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>.</span><span class=na>getObjectB</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>b</span><span class=p>.</span><span class=na>isFlag</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>é—®é¢˜æ˜¯å‡ºåœ¨è¿™é‡Œæå‰ä»aé‡Œé¢å–å‡ºäº†bä¹ˆ,bå·²ç»æŒ‡å‘ä¸åŒçš„å†…å­˜åœ°å€äº†ä¹ˆ?ä¸åº”è¯¥å§&mldr;</p><p>ç¨åŠ æ€è€ƒ,ç¬¬ä¸‰ç§ç»“æœé‡Œ,b.flagç”¨volatileä¿®é¥°å,å°±å¯ä»¥æ­£å¸¸é€€å‡º,è¯´æ˜bè¿˜æ˜¯æŒ‡å‘çš„aé‡Œé¢çš„bçš„åœ°å€å•Š,æ²¡æ¯›ç—…å•Š.</p><p>çªç„¶æ„Ÿè§‰æ›´æ™•äº†,æŠŠåŸåšçš„è¯„è®ºç¿»åˆ°åº•,å‘ç°è¿˜çœŸæœ‰äººè¯„è®ºåˆ°è¿™ä¸ª,ä»è¯„è®ºé‡Œåˆå­¦åˆ°äº†å¾ˆå¤šä¸œè¥¿.</p><h4 id=åŸåšè¯„è®ºåŒºçš„è§£ç–‘><a href=#%e5%8e%9f%e5%8d%9a%e8%af%84%e8%ae%ba%e5%8c%ba%e7%9a%84%e8%a7%a3%e7%96%91>#</a>
åŸåšè¯„è®ºåŒºçš„è§£ç–‘</h4><p>Q: ä¸ºä»€ä¹ˆsysoutå½±å“ç»“æœ?</p><p>A: å¦‚æœåœ¨å¾ªç¯ä½“å†…åŠ ä¸€äº›è¯­å¥,æ¯”å¦‚sysoutæˆ–è€…newå¯¹è±¡ä¹‹ç±»çš„ç¨å¾®å¤æ‚è€Œè€—æ—¶çš„æ“ä½œ,å°±ä¼šå‘ç°å°±ç®—æ²¡æœ‰volatile,çº¿ç¨‹åŒæ ·å¯èƒ½è¢«æ­£å¸¸ä¸­æ–­.å› ä¸º<strong>ç»è¿‡é«˜è€—æ—¶æ“ä½œä¹‹å,CPUä¼š"æ€€ç–‘äººç”Ÿ"</strong>,å•å¿ƒè‡ªå·±å¯¹b.flagçš„ç¼“å­˜ä¸æ˜¯æœ€æ–°çš„,è€Œå»ä»ä¸»å­˜è·å–.åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¼šç»“æŸï¼Œåªä¸è¿‡ä¸åŠæ—¶è€Œå·²ã€‚</p><p>Q: ä¸ºä»€ä¹ˆ while (b.isFlag()) å’Œwhile(a.getObjectB.isFlag()) ç»“æœæœ‰åŒºåˆ«,åè€…å°±å¯ä»¥æ‹¿åˆ°æœ€æ–°çš„flagå€¼?</p><p>A: ä¸€ä¸ªvolatileå¼•ç”¨çš„åŸŸæˆ–è€…å…ƒç´ å¹¶ä¸å…·å¤‡volatileç‰¹æ€§ï¼Œå› ä¸ºå¯¹äºè¯¥åŸŸçš„å†™å…¥å¹¶ä¸ä¼šè§¦å‘StoreLoadå±éšœï¼Œå°±<strong>ä¸ä¼šå¼ºè¿«è¯¥åŸŸå€¼ç«‹åˆ»å›å†™ä¸»å­˜</strong>ã€‚ä¸è¿‡å…¶è¯»ç‰¹æ€§å¹¶æ²¡æœ‰é—®é¢˜ï¼Œ<strong>å¯¹volatileçš„è¯»æ“ä½œä¸€å®šæ˜¯å»ä¸»å­˜å½“ä¸­è¯»å–çš„</strong>ã€‚</p><p>æ‰€ä»¥a.getObjectB åœ¨è¿™é‡Œaå°±å·²ç»å»ä»ä¸»å­˜ä¸­è¯»å–äº†.</p><p>è¿™ä¸€ç‚¹å› æ­¤ä¹Ÿå°±è§£é‡Šäº†ç¬¬ä¸€ä¸ªä¾‹å­ä¸­,æˆ‘ä»¬ä¿®æ”¹a.flag,å¯ä»¥æ­£å¸¸åœ°è¯»åˆ°flagå€¼.</p><p>Q: ä½†æ˜¯é—®é¢˜åˆæ¥äº†,å†™å…¥ä¸èƒ½ä¿è¯åˆ·æ–°åˆ°ä¸»å­˜çš„è¯,å²‚ä¸æ˜¯å³ä½¿<code>while(a.getObjectB.isFlag())</code> ä¹Ÿæ˜¯ä»ç„¶å¾ˆæœ‰å¯èƒ½å¤±è´¥çš„?ç»è¿‡åˆšæ‰ä¾‹å­çš„åå¤æµ‹è¯•,ä¾ç„¶å¾ˆéš¾ç¢°åˆ°ç»ˆæ­¢çº¿ç¨‹å¤±è´¥çš„æƒ…å†µ.</p><p>A: è¿™ä¸ªä¾‹å­è¿˜æ˜¯æ— æ³•æµ‹å‡ºè¿™ç§åˆ·æ–°ä¸»å­˜ä¸åŠæ—¶çš„æƒ…å†µ,æ¯•ç«Ÿå³ä½¿æ˜¯ä¸åŠæ—¶åˆ·æ–°,æœ€ç»ˆåˆ·æ–°äº†è¿˜æ˜¯å¯ä»¥è®©å­çº¿ç¨‹ç»“æŸçš„.</p><p><a class=link href=http://ifeve.com/volatile-array-visiblity/ target=_blank rel=noopener>å¦å¤–ä¸€ç¯‡åšå®¢</a> ä»æ±‡ç¼–è¯­å¥çš„è§’åº¦åˆ†æäº†<strong>volatileçš„æ•°ç»„åªé’ˆå¯¹æ•°ç»„çš„å¼•ç”¨å…·æœ‰volatileçš„è¯­ä¹‰ï¼Œè€Œä¸æ˜¯å®ƒçš„å…ƒç´ </strong> , æš‚æ—¶åªèƒ½è®°å½•ä¸‹æ¥,å¾…ä»¥åå†æ·±å…¥åŸç†å»ç†è§£.</p><h4 id=ç•™ä¸‹æ›´å¤šçš„ç–‘æƒ‘><a href=#%e7%95%99%e4%b8%8b%e6%9b%b4%e5%a4%9a%e7%9a%84%e7%96%91%e6%83%91>#</a>
ç•™ä¸‹æ›´å¤šçš„ç–‘æƒ‘</h4><ol><li><p>å¦‚ä¸Šé¢æ‰€è¯´,ä¸€ä¸ªvolatileå¼•ç”¨çš„åŸŸæˆ–è€…å…ƒç´ å¹¶ä¸å…·å¤‡volatileç‰¹æ€§ï¼Œå› ä¸ºå¯¹äºè¯¥åŸŸçš„å†™å…¥å¹¶ä¸ä¼šè§¦å‘StoreLoadå±éšœï¼Œå°±<strong>ä¸ä¼šå¼ºè¿«è¯¥åŸŸå€¼ç«‹åˆ»å›å†™ä¸»å­˜</strong>ã€‚ å¦‚ä½•è¯æ˜?</p></li><li><p>springé‡Œç”¨ç½®æ¢çš„æ–¹å¼çœŸçš„ä¸ä¼šå‡ºé—®é¢˜ä¹ˆ? å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–äº†ä¸€ä¸ªlist,ç„¶åå„è‡ªåŠ ä¸€ä¸ªå…ƒç´ è¿›å»,åˆ·æ–°,è¿™æ ·ä¸å°±å‡ºäº†é—®é¢˜?</p></li><li><p>å¦‚æœè¯´è¿™æ ·å¹¶ä¸å®‰å…¨,é‚£ä¹ˆconcurrentåŒ…é‡Œæ˜¯æ€ä¹ˆå®ç°å®‰å…¨çš„listçš„å‘¢?</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>add</span><span class=p>(</span><span class=n>E</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>ReentrantLock</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>lock</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=na>lock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>elements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>elements</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>newElements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Arrays</span><span class=p>.</span><span class=na>copyOf</span><span class=p>(</span><span class=n>elements</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>newElements</span><span class=o>[</span><span class=n>len</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>setArray</span><span class=p>(</span><span class=n>newElements</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>lock</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>ReentrantLock è²Œä¼¼æ˜¯å®‰å…¨äº†, ä½†æ˜¯ä¸ºä»€ä¹ˆè¿™é‡Œä¹Ÿç”¨äº†ç½®æ¢æ•°ç»„å•Š???</p><p>â€‹</p></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/%E7%AC%94%E8%AE%B0/>ç¬”è®°</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>ç›¸å…³æ–‡ç« </h2><div class=related-content><div class="flex article-list--tile"><article><a href=/p/%E6%9E%81%E7%AE%80-spring-%E6%A1%86%E6%9E%B6--%E6%B5%85%E6%9E%90%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/><div class=article-details><h2 class=article-title>æç®€ Spring æ¡†æ¶ -- æµ…æå¾ªç¯ä¾èµ–</h2></div></a></article><article><a href=/p/spring-%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0-2.8-%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%AF%BB%E6%89%BE-bean--%E6%89%BE%E5%87%BA%E6%89%80%E6%9C%89%E5%8C%B9%E9%85%8D%E7%B1%BB%E5%9E%8B%E7%9A%84-beanname/><div class=article-details><h2 class=article-title>Spring æºç ç¬”è®°-2.8 æ ¹æ®ç±»å‹å¯»æ‰¾ bean--æ‰¾å‡ºæ‰€æœ‰åŒ¹é…ç±»å‹çš„ beanName</h2></div></a></article><article><a href=/p/spring-%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0-2.7-%E6%A0%B9%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%AF%BB%E6%89%BE-bean/><div class=article-details><h2 class=article-title>Spring æºç ç¬”è®°-2.7 æ ¹æ®ç±»å‹å¯»æ‰¾ bean</h2></div></a></article><article><a href=/p/spring-%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0-2.6-beanwrapper-%E5%AF%B9%E6%AF%94-mybatis/><div class=article-details><h2 class=article-title>Spring æºç ç¬”è®°-2.6 BeanWrapper å¯¹æ¯” MyBatis</h2></div></a></article><article><a href=/p/spring%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0-2.5-createbean/><div class=article-details><h2 class=article-title>Springæºç ç¬”è®°-2.5 createBean</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2017 -
2024 Heeexy</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>