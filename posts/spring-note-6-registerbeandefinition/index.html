<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="# 本文要看啥 这个bean总算是解析完了,也装饰完了,等于是说信息我们都提取好了,现在该做的就是去注册啦. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, this.getReaderContext().getRegistry()); 就是这个方法了 # 开始进入方法吧 public static void registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException { String beanName = definitionHolder.getBeanName(); registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); String[] aliases = definitionHolder.getAliases(); if (aliases != null) { String[] var4 = aliases; int var5 = aliases.length; for(int var6 = 0; var6 < var5; ++var6) { String alias = var4[var6]; registry.registerAlias(beanName, alias); } } } 拿到beanName 用beanName和bd去registry里注册. registry是个接口,具体的实现在4.3.7版本中看到两种,一种是SimpleBeanDefinitionRegistry里,和它名字一样非常简单,就是塞进map, 另外一种就复杂了,稍后我们再来看 用beanName和alias去registry里注册 注册aliases也是接口 ,BeanDefinitionRegistry还是继承自AliasRegistry的, 4.3.7只看到SimpleAliasRegistry一种实现 注册alias就简单多了, SimpleAliasRegistry里有"><title>Spring源码笔记-1.4 获取bean流程之注册BeanDefinition</title>
<link rel=canonical href=https://heeexy.com/posts/spring-note-6-registerbeandefinition/><link rel=stylesheet href=/scss/style.min.760e3dabc1e140d2e6abd27a8ca0aabb60e568829b29f67d2df12024136eff37.css><meta property='og:title' content="Spring源码笔记-1.4 获取bean流程之注册BeanDefinition"><meta property='og:description' content="# 本文要看啥 这个bean总算是解析完了,也装饰完了,等于是说信息我们都提取好了,现在该做的就是去注册啦. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, this.getReaderContext().getRegistry()); 就是这个方法了 # 开始进入方法吧 public static void registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException { String beanName = definitionHolder.getBeanName(); registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); String[] aliases = definitionHolder.getAliases(); if (aliases != null) { String[] var4 = aliases; int var5 = aliases.length; for(int var6 = 0; var6 < var5; ++var6) { String alias = var4[var6]; registry.registerAlias(beanName, alias); } } } 拿到beanName 用beanName和bd去registry里注册. registry是个接口,具体的实现在4.3.7版本中看到两种,一种是SimpleBeanDefinitionRegistry里,和它名字一样非常简单,就是塞进map, 另外一种就复杂了,稍后我们再来看 用beanName和alias去registry里注册 注册aliases也是接口 ,BeanDefinitionRegistry还是继承自AliasRegistry的, 4.3.7只看到SimpleAliasRegistry一种实现 注册alias就简单多了, SimpleAliasRegistry里有"><meta property='og:url' content='https://heeexy.com/posts/spring-note-6-registerbeandefinition/'><meta property='og:site_name' content='网站标题'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='java'><meta property='article:tag' content='spring'><meta property='article:tag' content='笔记'><meta property='article:published_time' content='2017-09-15T21:26:00+00:00'><meta property='article:modified_time' content='2017-09-15T21:26:00+00:00'><meta name=twitter:title content="Spring源码笔记-1.4 获取bean流程之注册BeanDefinition"><meta name=twitter:description content="# 本文要看啥 这个bean总算是解析完了,也装饰完了,等于是说信息我们都提取好了,现在该做的就是去注册啦. BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, this.getReaderContext().getRegistry()); 就是这个方法了 # 开始进入方法吧 public static void registerBeanDefinition(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) throws BeanDefinitionStoreException { String beanName = definitionHolder.getBeanName(); registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition()); String[] aliases = definitionHolder.getAliases(); if (aliases != null) { String[] var4 = aliases; int var5 = aliases.length; for(int var6 = 0; var6 < var5; ++var6) { String alias = var4[var6]; registry.registerAlias(beanName, alias); } } } 拿到beanName 用beanName和bd去registry里注册. registry是个接口,具体的实现在4.3.7版本中看到两种,一种是SimpleBeanDefinitionRegistry里,和它名字一样非常简单,就是塞进map, 另外一种就复杂了,稍后我们再来看 用beanName和alias去registry里注册 注册aliases也是接口 ,BeanDefinitionRegistry还是继承自AliasRegistry的, 4.3.7只看到SimpleAliasRegistry一种实现 注册alias就简单多了, SimpleAliasRegistry里有"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>网站标题</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/spring-note-6-registerbeandefinition/>Spring源码笔记-1.4 获取bean流程之注册BeanDefinition</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 15, 2017</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>2 minute read</time></div></footer></div></header><section class=article-content><h3 id=本文要看啥><a href=#%e6%9c%ac%e6%96%87%e8%a6%81%e7%9c%8b%e5%95%a5 class=header-anchor>#</a>
本文要看啥</h3><hr><p>这个bean总算是解析完了,也装饰完了,等于是说信息我们都提取好了,现在该做的就是去注册啦.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> BeanDefinitionReaderUtils.<span style=color:#a6e22e>registerBeanDefinition</span>(bdHolder, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getReaderContext</span>().<span style=color:#a6e22e>getRegistry</span>());
</span></span></code></pre></div><p>就是这个方法了</p><h3 id=开始进入方法吧><a href=#%e5%bc%80%e5%a7%8b%e8%bf%9b%e5%85%a5%e6%96%b9%e6%b3%95%e5%90%a7 class=header-anchor>#</a>
开始进入方法吧</h3><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>registerBeanDefinition</span>(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry) <span style=color:#66d9ef>throws</span> BeanDefinitionStoreException {
</span></span><span style=display:flex><span>    String beanName <span style=color:#f92672>=</span> definitionHolder.<span style=color:#a6e22e>getBeanName</span>();
</span></span><span style=display:flex><span>    registry.<span style=color:#a6e22e>registerBeanDefinition</span>(beanName, definitionHolder.<span style=color:#a6e22e>getBeanDefinition</span>());
</span></span><span style=display:flex><span>    String<span style=color:#f92672>[]</span> aliases <span style=color:#f92672>=</span> definitionHolder.<span style=color:#a6e22e>getAliases</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (aliases <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        String<span style=color:#f92672>[]</span> var4 <span style=color:#f92672>=</span> aliases;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>int</span> var5 <span style=color:#f92672>=</span> aliases.<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> var6 <span style=color:#f92672>=</span> 0; var6 <span style=color:#f92672>&lt;</span> var5; <span style=color:#f92672>++</span>var6) {
</span></span><span style=display:flex><span>            String alias <span style=color:#f92672>=</span> var4<span style=color:#f92672>[</span>var6<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>            registry.<span style=color:#a6e22e>registerAlias</span>(beanName, alias);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li><p>拿到beanName</p></li><li><p>用beanName和bd去registry里注册.</p><blockquote><p>registry是个接口,具体的实现在4.3.7版本中看到两种,一种是SimpleBeanDefinitionRegistry里,和它名字一样非常简单,就是塞进map, 另外一种就复杂了,稍后我们再来看</p></blockquote></li><li><p>用beanName和alias去registry里注册</p><blockquote><p>注册aliases也是接口 ,BeanDefinitionRegistry还是继承自AliasRegistry的, 4.3.7只看到SimpleAliasRegistry一种实现</p></blockquote><p>注册alias就简单多了, SimpleAliasRegistry里有</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>final</span> Map<span style=color:#f92672>&lt;</span>String, String<span style=color:#f92672>&gt;</span> aliasMap <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ConcurrentHashMap(16);
</span></span></code></pre></div><p>稍后我再另开一文把SimpleAliasRegistry来读一遍</p></li></ol><h3 id=注册beandefinitionholder><a href=#%e6%b3%a8%e5%86%8cbeandefinitionholder class=header-anchor>#</a>
注册BeanDefinitionHolder</h3><hr><p>除了之前的<code>SimpleBeanDefinitionRegistry</code> 直接往map里面塞值的注册方式之外,我们还有DefaultListableBeanFactory 这个类来实现注册功能,我们主要来了解一下这种注册方式</p><ol><li><p>校验空参数</p></li><li><p>如果bdh是<code>AbstractBeanDefinition</code> ,那就要执行它的<code>validate()</code> 校验</p><ol><li>bdh的methodOverride和它的工厂<strong>不能同时存在</strong></li><li>如果它beanClass有值,那就要为方法覆盖做准备 <code>prepareMethodOverrides()</code> ,遍历它的overrides,找这个Bean的Class里面有几个叫这个名字的方法, <strong>如果0个,就抛错</strong>,如果1个,就设置重载属性为false表示没重载.</li></ol></li><li><p>从这个工厂里面<code>beanDefinitionMap</code> 拿原来的叫这个beanName的bd出来,如果不为空,进行下列校验及操作</p><blockquote><p>书中源码spring 3.2 采用sychronized , 而4.3版本的beanDefinitionMap已经用上了ConcurrentHashMap,并且map的value用了BD,而不是3.2里面的Object</p></blockquote><ol><li>如果工厂不允许bean覆盖,那么抛错</li><li>如果旧bean的role值小于新的,或者新旧bd完全相等,或者不相等,各打印一下日志</li><li>把新的bd放入<code>beanDefinitionMap</code></li></ol></li><li><p>第一次注册这个bean, 如果本工厂的<code>alreadyCreated</code> 也是空的话,那就不用加锁,直接</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#75715e>//map里塞入bd                </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionMap</span>.<span style=color:#a6e22e>put</span>(beanName, beanDefinition);
</span></span><span style=display:flex><span> <span style=color:#75715e>//已注册名字里加入beanName              </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionNames</span>.<span style=color:#a6e22e>add</span>(beanName);
</span></span><span style=display:flex><span> <span style=color:#75715e>//唯一名册里移出beanName(啥时候加入了???)              </span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>manualSingletonNames</span>.<span style=color:#a6e22e>remove</span>(beanName);
</span></span></code></pre></div><p>如果本工程已经有创建过bean了,那么接下来一段代码就要加synchronized了</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Map var4 <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionMap</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>synchronized</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionMap</span>) {
</span></span><span style=display:flex><span>   <span style=color:#75715e>//map里塞入bd        </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionMap</span>.<span style=color:#a6e22e>put</span>(beanName, beanDefinition);
</span></span><span style=display:flex><span>  <span style=color:#75715e>//注意到后面这段操作其实是新建个数组,加上这次注册beanName,然后替换之前的数组....</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//为什么这么复杂呢???</span>
</span></span><span style=display:flex><span>    List<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> updatedDefinitions <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ArrayList(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionNames</span>.<span style=color:#a6e22e>size</span>() <span style=color:#f92672>+</span> 1);
</span></span><span style=display:flex><span>    updatedDefinitions.<span style=color:#a6e22e>addAll</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionNames</span>);
</span></span><span style=display:flex><span>    updatedDefinitions.<span style=color:#a6e22e>add</span>(beanName);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beanDefinitionNames</span> <span style=color:#f92672>=</span> updatedDefinitions;
</span></span><span style=display:flex><span>  <span style=color:#75715e>//如果唯一名册里包含beanName</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>manualSingletonNames</span>.<span style=color:#a6e22e>contains</span>(beanName)) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>//就移出去,但是这里也和上面一样,搞替换....</span>
</span></span><span style=display:flex><span>        Set<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>&gt;</span> updatedSingletons <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> LinkedHashSet(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>manualSingletonNames</span>);
</span></span><span style=display:flex><span>        updatedSingletons.<span style=color:#a6e22e>remove</span>(beanName);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>manualSingletonNames</span> <span style=color:#f92672>=</span> updatedSingletons;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>疑问: 这里都用了替换,明明<code>beanDefinitionNames</code> 和<code>manualSingletonNames</code> 都是volatile声明的,每次读都从主内存取,每次写都都将值写到主内存, 这里为什么还要这么麻烦得去开新的list和set,替换旧的呢?</p><p>答:从网上搜到,volatile修饰的变量如果是对象或数组之类的，其含义是对象或数组的<strong>地址具有可见性</strong>，但是数组或对象<strong>内部的成员改变不具备可见性</strong>,那等于就是说非得整个地址替换才行咯.</p><p>很爽,从这本书要跳到我正在读的并发编程相关的内容了,这几天再去研究一波volatile,可以再开一文. <a class=link href=http://blog.csdn.net/u014108122/article/details/38173201 target=_blank rel=noopener>准备参考地址</a></p></blockquote></li></ol><p>然后<code>this.frozenBeanDefinitionNames = null;</code> 这个冻结/取消冻结bdNames的功能暂时也不知道干啥的,在注册和删除bd的地方看到了这样的置为null,</p><p>​ 只在<code>freezeConfiguration()</code> 方法内看到把它置为bdNames转的String[] .</p><p>​ 另外在<code>getBeanDefinitionNames()</code> 方法里有判断这个</p><p>然后</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#75715e>//如果有老bd或者 这个bean是单例对象?</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> (oldBeanDefinition <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>containsSingleton</span>(beanName)) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>//重置bean</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>resetBeanDefinition</span>(beanName);
</span></span><span style=display:flex><span>        }
</span></span></code></pre></div><p>重置的主要内容有</p><ul><li>清除mergedBD</li><li>销毁单例</li><li>遍历之前的bean,看新注册的这个bean是谁的爹(parent),那些儿子也都要调用这个方法进行重置</li></ul><blockquote><p>不得不说这个<code>DefaultListableBeanFactory</code> 的成员变量实在太多了,搞不清楚一个个都是要干啥的,后面再次遇到的时候再慢慢看吧</p></blockquote><h3 id=注册alias><a href=#%e6%b3%a8%e5%86%8calias class=header-anchor>#</a>
注册Alias</h3><hr><p>4.3.7版本的实现在<code>SimpleAliasRegistry</code> 里, 详情见 <a class=link href=/2017/09/15/spring_SimpleAliasRegistry/>这一篇博文</a></p><h3 id=注册完成><a href=#%e6%b3%a8%e5%86%8c%e5%ae%8c%e6%88%90 class=header-anchor>#</a>
注册完成</h3><hr><p>其实没有操作了, 但是作者留了个位置在这</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>  <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getReaderContext</span>().<span style=color:#a6e22e>fireComponentRegistered</span>(<span style=color:#66d9ef>new</span> BeanComponentDefinition(bdHolder));
</span></span></code></pre></div><p>如果程序开发人员需要对注册BeanDefinition时间进行监听时,可以通过注册监听器的方式来做.Spring并没有再此做任何逻辑处理</p><h3 id=告一段落><a href=#%e5%91%8a%e4%b8%80%e6%ae%b5%e8%90%bd class=header-anchor>#</a>
告一段落</h3><hr><p>至此,我们的解析注册Bean标签可算是告一段落啦,虽然里面还留下了很多疑问待后续阅读中弄清.</p><p>先想想之前是在哪分叉出去的吧.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>parseDefaultElement</span>(Element ele, BeanDefinitionParserDelegate delegate) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (delegate.<span style=color:#a6e22e>nodeNameEquals</span>(ele, <span style=color:#e6db74>&#34;import&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>importBeanDefinitionResource</span>(ele);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (delegate.<span style=color:#a6e22e>nodeNameEquals</span>(ele, <span style=color:#e6db74>&#34;alias&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>processAliasRegistration</span>(ele);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (delegate.<span style=color:#a6e22e>nodeNameEquals</span>(ele, <span style=color:#e6db74>&#34;bean&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>//就是这里啦,我们先去阅读最复杂的bean的</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>processBeanDefinition</span>(ele, delegate);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (delegate.<span style=color:#a6e22e>nodeNameEquals</span>(ele, <span style=color:#e6db74>&#34;beans&#34;</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#75715e>//这个地方我还记得,beans标签是绕回去解析的,不用看了</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>doRegisterBeanDefinitions</span>(ele);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>再之前呢,</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>parseBeanDefinitions</span>(Element root, BeanDefinitionParserDelegate delegate) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (delegate.<span style=color:#a6e22e>isDefaultNamespace</span>(root)) {
</span></span><span style=display:flex><span>            NodeList nl <span style=color:#f92672>=</span> root.<span style=color:#a6e22e>getChildNodes</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> 0; i <span style=color:#f92672>&lt;</span> nl.<span style=color:#a6e22e>getLength</span>(); <span style=color:#f92672>++</span>i) {
</span></span><span style=display:flex><span>                Node node <span style=color:#f92672>=</span> nl.<span style=color:#a6e22e>item</span>(i);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (node <span style=color:#66d9ef>instanceof</span> Element) {
</span></span><span style=display:flex><span>                    Element ele <span style=color:#f92672>=</span> (Element)node;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (delegate.<span style=color:#a6e22e>isDefaultNamespace</span>(ele)) {
</span></span><span style=display:flex><span>                      <span style=color:#75715e>//就是这个地方,差不多想起来了,beans标签里面的子元素, 如果是默认命名空间,就按默认方式去解析</span>
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>parseDefaultElement</span>(ele, delegate);
</span></span><span style=display:flex><span>                    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                      <span style=color:#75715e>//这里是个分叉,解析自定义元素,以后再看</span>
</span></span><span style=display:flex><span>                        delegate.<span style=color:#a6e22e>parseCustomElement</span>(ele);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    		<span style=color:#75715e>//这和上面一样的分叉,解析自定义元素</span>
</span></span><span style=display:flex><span>            delegate.<span style=color:#a6e22e>parseCustomElement</span>(root);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>再之前呢</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>doRegisterBeanDefinitions</span>(Element root) {
</span></span><span style=display:flex><span>    BeanDefinitionParserDelegate parent <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>delegate</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createDelegate</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getReaderContext</span>(), root, parent);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>delegate</span>.<span style=color:#a6e22e>isDefaultNamespace</span>(root)) {
</span></span><span style=display:flex><span>        String profileSpec <span style=color:#f92672>=</span> root.<span style=color:#a6e22e>getAttribute</span>(<span style=color:#e6db74>&#34;profile&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (StringUtils.<span style=color:#a6e22e>hasText</span>(profileSpec)) {
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> specifiedProfiles <span style=color:#f92672>=</span> StringUtils.<span style=color:#a6e22e>tokenizeToStringArray</span>(profileSpec, <span style=color:#e6db74>&#34;,; &#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getReaderContext</span>().<span style=color:#a6e22e>getEnvironment</span>().<span style=color:#a6e22e>acceptsProfiles</span>(specifiedProfiles)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>isInfoEnabled</span>()) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>info</span>(<span style=color:#e6db74>&#34;Skipped XML bean definition file due to specified profiles [&#34;</span> <span style=color:#f92672>+</span> profileSpec <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;] not matching: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getReaderContext</span>().<span style=color:#a6e22e>getResource</span>());
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>preProcessXml</span>(root);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//从这里走出去的</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>parseBeanDefinitions</span>(root, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>delegate</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>postProcessXml</span>(root);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>delegate</span> <span style=color:#f92672>=</span> parent;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>到这还要温习一遍的话,可以去看Spring的<a class=link href=/2017/09/11/spring_note_1/>第一篇笔记</a>了</p><p>哈哈,这么点东西,读了一个礼拜,读了后面的忘了前面的,还是在读读记记的情况下,</p><p>要是没有这个笔记,这时候估计已经迷路得要放弃了,不容易啊</p><p>不说了 <a class=link href=/2017/09/15/spring_SimpleAliasRegistry/>SimpleAliasRegistry</a> 和<code>volatile</code> 两篇文章的坑还留着呢,继续&mldr;</p></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/spring/>Spring</a>
<a href=/tags/%E7%AC%94%E8%AE%B0/>笔记</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/spring-note-4-decoratebeandefinitionifrequired/><div class=article-details><h2 class=article-title>Spring源码笔记-1.3 获取bean流程之解析bean标签中的自定义标签元素</h2></div></a></article><article><a href=/posts/spring-note-3-constructorargumentvalues/><div class=article-details><h2 class=article-title>ConstructorArgumentValues 构造器参数值保存器</h2></div></a></article><article><a href=/posts/spring-note-2/><div class=article-details><h2 class=article-title>Spring源码笔记-1.2 获取bean流程之bean标签的解析及注册</h2></div></a></article><article><a href=/posts/spring-note-1/><div class=article-details><h2 class=article-title>Spring源码笔记-1.1 获取bean流程之容器的基本实现</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 网站标题</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>