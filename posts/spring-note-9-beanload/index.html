<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='# 本文要看啥? \u200b\t前面已经了解了bean从配置文件到解析成BDHolder到注册的流程,我们已经将bean的信息封装好,塞入了map中,这个map可能在不同的实现里面,前面重点学的就是DefaultListableBeanFactory里的beanDefinitionMap. \u200b\t我们现在要探索bean的加载,围绕最初的示例代码: MyTestBean bean =(MyTestBean)bf.getBean("myTestBean"); \u200b\tBeanFactory是个接口,其下实现关系很复杂, getBean方法的实现主要是在AbstractBeanFactory 这一层. \u200b\t本文就是先来快速体验一下加载bean的大体流程 # 进入代码吧 protected <T> T doGetBean(String name, Class<T> requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException { //转换beanName final String beanName = this.transformedBeanName(name); //根据beanName找其单例 Object sharedInstance = this.getSingleton(beanName); Object bean; if (sharedInstance != null && args == null) { if (this.logger.isDebugEnabled()) { if (this.isSingletonCurrentlyInCreation(beanName)) { this.logger.debug("Returning eagerly cached instance of singleton bean &#39;" + beanName + "&#39; that is not fully initialized yet - a consequence of a circular reference"); } else { this.'><title>Spring源码笔记-2.1 bean的加载初探</title>
<link rel=canonical href=https://heeexy.com/posts/spring-note-9-beanload/><link rel=stylesheet href=/scss/style.min.760e3dabc1e140d2e6abd27a8ca0aabb60e568829b29f67d2df12024136eff37.css><meta property='og:title' content="Spring源码笔记-2.1 bean的加载初探"><meta property='og:description' content='# 本文要看啥? \u200b\t前面已经了解了bean从配置文件到解析成BDHolder到注册的流程,我们已经将bean的信息封装好,塞入了map中,这个map可能在不同的实现里面,前面重点学的就是DefaultListableBeanFactory里的beanDefinitionMap. \u200b\t我们现在要探索bean的加载,围绕最初的示例代码: MyTestBean bean =(MyTestBean)bf.getBean("myTestBean"); \u200b\tBeanFactory是个接口,其下实现关系很复杂, getBean方法的实现主要是在AbstractBeanFactory 这一层. \u200b\t本文就是先来快速体验一下加载bean的大体流程 # 进入代码吧 protected <T> T doGetBean(String name, Class<T> requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException { //转换beanName final String beanName = this.transformedBeanName(name); //根据beanName找其单例 Object sharedInstance = this.getSingleton(beanName); Object bean; if (sharedInstance != null && args == null) { if (this.logger.isDebugEnabled()) { if (this.isSingletonCurrentlyInCreation(beanName)) { this.logger.debug("Returning eagerly cached instance of singleton bean &#39;" + beanName + "&#39; that is not fully initialized yet - a consequence of a circular reference"); } else { this.'><meta property='og:url' content='https://heeexy.com/posts/spring-note-9-beanload/'><meta property='og:site_name' content='网站标题'><meta property='og:type' content='article'><meta property='article:section' content='Posts'><meta property='article:tag' content='java'><meta property='article:tag' content='spring'><meta property='article:tag' content='笔记'><meta property='article:published_time' content='2017-09-26T11:16:00+00:00'><meta property='article:modified_time' content='2017-09-26T11:16:00+00:00'><meta name=twitter:title content="Spring源码笔记-2.1 bean的加载初探"><meta name=twitter:description content='# 本文要看啥? \u200b\t前面已经了解了bean从配置文件到解析成BDHolder到注册的流程,我们已经将bean的信息封装好,塞入了map中,这个map可能在不同的实现里面,前面重点学的就是DefaultListableBeanFactory里的beanDefinitionMap. \u200b\t我们现在要探索bean的加载,围绕最初的示例代码: MyTestBean bean =(MyTestBean)bf.getBean("myTestBean"); \u200b\tBeanFactory是个接口,其下实现关系很复杂, getBean方法的实现主要是在AbstractBeanFactory 这一层. \u200b\t本文就是先来快速体验一下加载bean的大体流程 # 进入代码吧 protected <T> T doGetBean(String name, Class<T> requiredType, final Object[] args, boolean typeCheckOnly) throws BeansException { //转换beanName final String beanName = this.transformedBeanName(name); //根据beanName找其单例 Object sharedInstance = this.getSingleton(beanName); Object bean; if (sharedInstance != null && args == null) { if (this.logger.isDebugEnabled()) { if (this.isSingletonCurrentlyInCreation(beanName)) { this.logger.debug("Returning eagerly cached instance of singleton bean &#39;" + beanName + "&#39; that is not fully initialized yet - a consequence of a circular reference"); } else { this.'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_huda2458f72ce188392d75c5d51cd8e24e_373_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>网站标题</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/spring-note-9-beanload/>Spring源码笔记-2.1 bean的加载初探</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Sep 26, 2017</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>3 minute read</time></div></footer></div></header><section class=article-content><h3 id=本文要看啥><a href=#%e6%9c%ac%e6%96%87%e8%a6%81%e7%9c%8b%e5%95%a5 class=header-anchor>#</a>
本文要看啥?</h3><p>​ 前面已经了解了bean从配置文件到解析成BDHolder到注册的流程,我们已经将bean的信息封装好,塞入了map中,这个map可能在不同的实现里面,前面重点学的就是DefaultListableBeanFactory里的beanDefinitionMap.</p><p>​ 我们现在要探索bean的加载,围绕最初的示例代码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>				MyTestBean bean <span style=color:#f92672>=</span>(MyTestBean)bf.<span style=color:#a6e22e>getBean</span>(<span style=color:#e6db74>&#34;myTestBean&#34;</span>);
</span></span></code></pre></div><p>​ BeanFactory是个接口,其下实现关系很复杂, getBean方法的实现主要是在<code>AbstractBeanFactory</code> 这一层.</p><p>​ 本文就是先来快速体验一下加载bean的大体流程</p><h3 id=进入代码吧><a href=#%e8%bf%9b%e5%85%a5%e4%bb%a3%e7%a0%81%e5%90%a7 class=header-anchor>#</a>
进入代码吧</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>protected</span> <span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> T <span style=color:#a6e22e>doGetBean</span>(String name, Class<span style=color:#f92672>&lt;</span>T<span style=color:#f92672>&gt;</span> requiredType, <span style=color:#66d9ef>final</span> Object<span style=color:#f92672>[]</span> args, <span style=color:#66d9ef>boolean</span> typeCheckOnly) <span style=color:#66d9ef>throws</span> BeansException {
</span></span><span style=display:flex><span>	<span style=color:#75715e>//转换beanName</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>final</span> String beanName <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>transformedBeanName</span>(name);
</span></span><span style=display:flex><span>    <span style=color:#75715e>//根据beanName找其单例</span>
</span></span><span style=display:flex><span>    Object sharedInstance <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSingleton</span>(beanName);
</span></span><span style=display:flex><span>    Object bean;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (sharedInstance <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> args <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isSingletonCurrentlyInCreation</span>(beanName)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Returning eagerly cached instance of singleton bean &#39;&#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; that is not fully initialized yet - a consequence of a circular reference&#34;</span>);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Returning cached instance of singleton bean &#39;&#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>		<span style=color:#75715e>//返回对应的实例</span>
</span></span><span style=display:flex><span>        bean <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getObjectForBeanInstance</span>(sharedInstance, name, beanName, (RootBeanDefinition)<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      	<span style=color:#75715e>//原型模式下,如果这个bean已经正在创建中,说明是如下情况</span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>//A中有B的属性,B中有A的属性,当依赖注入的时候,就回产生当A还未创建完的时候,</span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>//因为对于B的创建,再次返回创建A,造成循环依赖</span>
</span></span><span style=display:flex><span>      	<span style=color:#75715e>//所以就会报错</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isPrototypeCurrentlyInCreation</span>(beanName)) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BeanCurrentlyInCreationException(beanName);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>		<span style=color:#75715e>//获取父工厂</span>
</span></span><span style=display:flex><span>        BeanFactory parentBeanFactory <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getParentBeanFactory</span>();
</span></span><span style=display:flex><span>      	<span style=color:#75715e>//如果本工厂没有这个bean,存在父工厂,就去父工厂找</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (parentBeanFactory <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>containsBeanDefinition</span>(beanName)) {
</span></span><span style=display:flex><span>            String nameToLookup <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>originalBeanName</span>(name);
</span></span><span style=display:flex><span>          	<span style=color:#75715e>//注意下面是递归地去父工厂找</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (args <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> parentBeanFactory.<span style=color:#a6e22e>getBean</span>(nameToLookup, args);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> parentBeanFactory.<span style=color:#a6e22e>getBean</span>(nameToLookup, requiredType);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>		<span style=color:#75715e>//如果不是仅仅做类检查则是创建bean,这里要进行记录</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>typeCheckOnly) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>markBeanAsCreated</span>(beanName);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>final</span> RootBeanDefinition mbd <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getMergedLocalBeanDefinition</span>(beanName);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkMergedBeanDefinition</span>(mbd, beanName, args);
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> dependsOn <span style=color:#f92672>=</span> mbd.<span style=color:#a6e22e>getDependsOn</span>();
</span></span><span style=display:flex><span>            String<span style=color:#f92672>[]</span> var11;
</span></span><span style=display:flex><span>          	<span style=color:#75715e>//如果存在依赖,就递归地先去实例化依赖的bean</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (dependsOn <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                var11 <span style=color:#f92672>=</span> dependsOn;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>int</span> var12 <span style=color:#f92672>=</span> dependsOn.<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span>(<span style=color:#66d9ef>int</span> var13 <span style=color:#f92672>=</span> 0; var13 <span style=color:#f92672>&lt;</span> var12; <span style=color:#f92672>++</span>var13) {
</span></span><span style=display:flex><span>                    String dep <span style=color:#f92672>=</span> var11<span style=color:#f92672>[</span>var13<span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isDependent</span>(beanName, dep)) {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BeanCreationException(mbd.<span style=color:#a6e22e>getResourceDescription</span>(), beanName, <span style=color:#e6db74>&#34;Circular depends-on relationship between &#39;&#34;</span> <span style=color:#f92672>+</span> beanName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; and &#39;&#34;</span> <span style=color:#f92672>+</span> dep <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>registerDependentBean</span>(dep, beanName);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getBean</span>(dep);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (mbd.<span style=color:#a6e22e>isSingleton</span>()) {
</span></span><span style=display:flex><span>              	<span style=color:#75715e>//单例模式的创建</span>
</span></span><span style=display:flex><span>                sharedInstance <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSingleton</span>(beanName, <span style=color:#66d9ef>new</span> ObjectFactory<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getObject</span>() <span style=color:#66d9ef>throws</span> BeansException {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> AbstractBeanFactory.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>createBean</span>(beanName, mbd, args);
</span></span><span style=display:flex><span>                        } <span style=color:#66d9ef>catch</span> (BeansException var2) {
</span></span><span style=display:flex><span>                            AbstractBeanFactory.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>destroySingleton</span>(beanName);
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>throw</span> var2;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                });
</span></span><span style=display:flex><span>                bean <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getObjectForBeanInstance</span>(sharedInstance, name, beanName, mbd);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (mbd.<span style=color:#a6e22e>isPrototype</span>()) {
</span></span><span style=display:flex><span>              	<span style=color:#75715e>//原型模式的创建</span>
</span></span><span style=display:flex><span>                var11 <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>                Object prototypeInstance;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                  	<span style=color:#75715e>//创建原型之前,先把prototypesCurrentlyInCreation里塞值,表示当前正在创建哪些原型</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>beforePrototypeCreation</span>(beanName);
</span></span><span style=display:flex><span>                  	<span style=color:#75715e>//注意到createBean这个方法留给了子类去实现</span>
</span></span><span style=display:flex><span>                    prototypeInstance <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createBean</span>(beanName, mbd, args);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>                  	<span style=color:#75715e>//移出prototypesCurrentlyInCreation,表示创建这个原型结束</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>afterPrototypeCreation</span>(beanName);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                bean <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getObjectForBeanInstance</span>(prototypeInstance, name, beanName, mbd);
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>              	<span style=color:#75715e>//其它模式的创建(指定的scope上实例化bean</span>
</span></span><span style=display:flex><span>                String scopeName <span style=color:#f92672>=</span> mbd.<span style=color:#a6e22e>getScope</span>();
</span></span><span style=display:flex><span>                Scope scope <span style=color:#f92672>=</span> (Scope)<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scopes</span>.<span style=color:#a6e22e>get</span>(scopeName);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> (scope <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> IllegalStateException(<span style=color:#e6db74>&#34;No Scope registered for scope name &#39;&#34;</span> <span style=color:#f92672>+</span> scopeName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                    Object scopedInstance <span style=color:#f92672>=</span> scope.<span style=color:#a6e22e>get</span>(beanName, <span style=color:#66d9ef>new</span> ObjectFactory<span style=color:#f92672>&lt;</span>Object<span style=color:#f92672>&gt;</span>() {
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>public</span> Object <span style=color:#a6e22e>getObject</span>() <span style=color:#66d9ef>throws</span> BeansException {
</span></span><span style=display:flex><span>                            AbstractBeanFactory.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>beforePrototypeCreation</span>(beanName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                            Object var1;
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>                                var1 <span style=color:#f92672>=</span> AbstractBeanFactory.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>createBean</span>(beanName, mbd, args);
</span></span><span style=display:flex><span>                            } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>AbstractBeanFactory.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>afterPrototypeCreation</span>(beanName);
</span></span><span style=display:flex><span>                            }
</span></span><span style=display:flex><span>                            <span style=color:#66d9ef>return</span> var1;
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    });
</span></span><span style=display:flex><span>                    bean <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getObjectForBeanInstance</span>(scopedInstance, name, beanName, mbd);
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>catch</span> (IllegalStateException var21) {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BeanCreationException(beanName, <span style=color:#e6db74>&#34;Scope &#39;&#34;</span> <span style=color:#f92672>+</span> scopeName <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; is not active for the current thread; consider defining a scoped proxy for this bean if you intend to refer to it from a singleton&#34;</span>, var21);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (BeansException var23) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupAfterBeanCreationFailure</span>(beanName);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> var23;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (requiredType <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> bean <span style=color:#f92672>!=</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>requiredType.<span style=color:#a6e22e>isAssignableFrom</span>(bean.<span style=color:#a6e22e>getClass</span>())) {
</span></span><span style=display:flex><span>      	<span style=color:#75715e>//检查类型是否符合bean的实际类型</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getTypeConverter</span>().<span style=color:#a6e22e>convertIfNecessary</span>(bean, requiredType);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (TypeMismatchException var22) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>isDebugEnabled</span>()) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>debug</span>(<span style=color:#e6db74>&#34;Failed to convert bean &#39;&#34;</span> <span style=color:#f92672>+</span> name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; to required type &#39;&#34;</span> <span style=color:#f92672>+</span> ClassUtils.<span style=color:#a6e22e>getQualifiedName</span>(requiredType) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39;&#34;</span>, var22);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> BeanNotOfRequiredTypeException(name, requiredType, bean.<span style=color:#a6e22e>getClass</span>());
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> bean;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=提炼大致步骤><a href=#%e6%8f%90%e7%82%bc%e5%a4%a7%e8%87%b4%e6%ad%a5%e9%aa%a4 class=header-anchor>#</a>
提炼大致步骤</h4><p>这120多行的代码,Spring都并没有再进行重构,可见其复杂程度,辛亏有书本解释,了解到大致步骤:</p><ol><li><p>转换对应的beanName,因为传入的参数可能是alias</p><p>从其具体方法中看,是之前见过的, 处理<code>&</code> 和别名的递归寻找本名.</p><p>去前面笔记中寻找,在 <a class=link href=http://heeexy.com/2017/09/15/spring_SimpleAliasRegistry/ target=_blank rel=noopener>SimpleAliasRegistry</a> 中已经研究过此方法</p></li><li><p>尝试从缓存中加载单例</p><p>此时可能从缓存中取出的是还没创建好的bean,主要是因为防止循环依赖</p></li><li><p>bean的实例化</p><p>如果从缓存中得到了bean的原始状态,则需要对bean进行实例化.</p></li><li><p>原型模式的依赖检查</p></li><li><p>检测parentBeanFactory</p></li><li><p>将存储XML配置文件的GernericBeanDefinition转换为RootBeanDefinition</p></li><li><p>寻找依赖</p><p>因为bean的初始化过程中很可能会用到某些属性,而某些属性很可能是动态配置的,并且配置成依赖于其他的bean,那么这个时候就有必要先加载依赖的bean.</p></li><li><p><strong>针对不同的scope进行bean的创建</strong></p></li><li><p>类型转换</p><p>有可能有这种情况,返回的bean,是个String,但是requiredType传入的是Integer类型,那么这时候本步骤就会起作用了. Spring中提供了各种各样的转换器,用户也可以自己扩展转换器来满足需求</p></li></ol></section><footer class=article-footer><section class=article-tags><a href=/tags/java/>Java</a>
<a href=/tags/spring/>Spring</a>
<a href=/tags/%E7%AC%94%E8%AE%B0/>笔记</a></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>Related content</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/spring-note-8-custom-element/><div class=article-details><h2 class=article-title>Spring源码笔记-1.6 自定义标签的解析</h2></div></a></article><article><a href=/posts/spring-note-7-other-default-elements/><div class=article-details><h2 class=article-title>Spring源码笔记-1.5 其它标签解析</h2></div></a></article><article><a href=/posts/spring-note-5-simplealiasregistry/><div class=article-details><h2 class=article-title>SimpleAliasRegistry</h2></div></a></article><article><a href=/posts/spring-note-6-registerbeandefinition/><div class=article-details><h2 class=article-title>Spring源码笔记-1.4 获取bean流程之注册BeanDefinition</h2></div></a></article><article><a href=/posts/spring-note-4-decoratebeandefinitionifrequired/><div class=article-details><h2 class=article-title>Spring源码笔记-1.3 获取bean流程之解析bean标签中的自定义标签元素</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2024 网站标题</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.25.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>